<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>SearchList</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
  <style>
    h1 {
      text-align: center;
      margin-top: 50px;
      display: inline-block;
      text-align: center;
    }

  </style>
</head>
<body>
<div style="text-align: center; margin-top: 50px;">
  <h1 style="display: inline;">SearchList</h1>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  &nbsp;&nbsp;&nbsp;
  <a class="link-offset-2 link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="/logout">
    로그아웃
  </a>
</div>
<hr />
<!-- <p th:text="${totalPages}"></p><p>totalPages</p> -->
<br/>
<!-- <p th:text="${bbsList.size()}"></p><p>bbsList.size</p> -->

<!-- Hidden input 요소 추가 -->
<input type="hidden" id="targetHidden" th:value="${searchparameter.target}" />
<input type="hidden" id="searchHidden" th:value="${searchparameter.search}" />
<input type="hidden" id="searchArr" th:value="${searchparameter.reDiscoverArr}" />
<input type="hidden" id="categoryHidden" th:value="${searchparameter.category}" />


<div class="border rounded p-3" style="width: 1500px;  height: 600px; margin: 0 auto;">


  <br/>
  <!-- 검색 및 정렬 -->
  <div class="row">

    <div class="col-md-2" style="width: 150px;">
      <select class="form-select" aria-label="Default select example" id="choice" onchange="setChoice(getValue(this));" th:field="${searchparameter.choice}" th:value="${searchparameter.choice}">
        <option th:value="accuracyorderby" th:selected="${choice=='accuracyorderby'}">정확도순</option>
        <option th:value="recentorderby" th:selected="${choice=='recentorderby'}">최신순</option>
        <option th:value="olderorderby" th:selected="${choice=='olderorderby'}">오래된순</option>
      </select>
    </div>

    <div class="col-md-10">
      <div class="input-group" style="float: right; margin-left: 250px;">
        <ul class="dropdown-menu dropdown-menu-end" id="target" onchange="getValue(this);" th:value="${target}">
          <li><a class="dropdown-item" onclick="setValue('getall')">전체</a></li>
          <li><a class="dropdown-item" onclick="setValue('gettitle')">제목</a></li>
          <li><a class="dropdown-item" onclick="setValue('getcontent')">내용</a></li>
          <li><a class="dropdown-item" onclick="setValue('getfilename')">파일 이름</a></li>
          <li><a class="dropdown-item" onclick="setValue('getfilecontent')">파일 내용</a></li>
        </ul>
        <input type="text" class="form-control" aria-label="Text input with segmented dropdown button" id="searchparam" th:value="${searchparameter.search}">
        <button type="button" class="btn btn-outline-secondary" onclick="SearchOption()">검색</button>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">Toggle Dropdown</span>
        </button>
      </div>
    </div>

  </div>
  <br/>

  <!-- 검색 결과물이 있는 경우에만 아래 출력 -->
  <div th:if="${data.hits != null and not #lists.isEmpty(data.hits.hits)}">



    <!-- 결과 내 재 검색 버튼 -->
    <div class="form-check form-switch" style="display: flex; justify-content: flex-end; margin-right: 50px;">
      <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" th:checked="${searchparameter.research}" onclick="updateReSearch()">
      <span>&nbsp;&nbsp;</span>
      <label class="form-check-label" for="flexSwitchCheckDefault">결과 내 전체 재검색</label>
    </div>

    <br/>

    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        카테고리 선택
      </button>
      <ul class="dropdown-menu" id="category" onchange="getValue(this);" th:value="${category}">
        <li><a class="dropdown-item" onclick="setCategoryValue('전체')">전체 카테고리</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('행안부 파일')">행안부 파일</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('행안부 이미지')">행안부 이미지</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('정치')">정치</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('전국')">전국</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('오피니언')">오피니언</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('연예')">연예</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('스포츠')">스포츠</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('세계')">세계</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('산업')">산업</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('사회')">사회</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('사람들')">사람들</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('북한')">북한</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('문화')">문화</a></li>
        <li><a class="dropdown-item" onclick="setCategoryValue('라이프')">라이프</a></li>
        <li><a class="dropdown-item" onclick="setValue('getfilecontent')">경제</a></li>
      </ul>
    </div>
    <span>현재 카테고리 : </span> <span id="categoryInnerLine" th:value="${category}"></span>



    <br/><br/>


    <h3>검색결과 : <span th:text="${data.hits.total.value}"></span> 건</h3>

  <table class="table">
    <thead class="table-dark">
    <th>제목</th>
    <th>카테고리</th>
    <th>작성자</th>
    <th>작성일</th>
    </thead>
    <tbody>
    <tr th:each="item : ${data.hits.hits}">
      <td th:text="${item._source.title}">Title</td>
      <td th:text="${item._source.category}">Category</td>
      <td th:text="${item._source.author}">Author</td>
      <td th:text="${item._source.wdate}">Date</td>
    </tr>
    </tbody>
  </table>

    <br/><br/>

    <!-- Pagination Logic -->
    <!-- 동적 할당 하기 위해서 지역변수 선언 -->
    <div th:with="choice=${searchparameter.choice}, search=${searchparameter.search}, target=${searchparameter.target}">
      <!-- 파지네이션 -->
      <nav aria-label="Page navigation" th:if="${totalPages > 0}">
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Previous" onclick="goToFirstPage(event)">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">First</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Previous" onclick="goToPrev(event)">
              <span aria-hidden="true"><</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          <!-- 페이지 링크를 동적으로 생성 -->
          <!-- 현재 페이지 그룹 계산 -->
          <th:block th:with="currentPageGroup=${(searchparameter.page - 1) / 10}">
            <li class="page-item" th:each="page : ${#numbers.sequence((currentPageGroup * 10) + 1, (currentPageGroup * 10) + 10)}"
                th:if="${page} &lt;= ${totalPages}">
              <a class="page-link" href="#" th:text="${page}" onclick="goToPage(this.innerText)"></a>
            </li>
          </th:block>
          <li class="page-item">
          <a class="page-link" href="#" aria-label="Next" onclick="goToNext(event)">
            <span class="sr-only">Next</span>
            <span aria-hidden="true">></span>
          </a>
          </li>
          <li class="page-item">

            <a class="page-link" href="#" aria-label="Next" onclick="goToLastPage(this.getAttribute('data-total-pages'))" th:data-total-pages="${totalPages}">
              <span class="sr-only">End</span>
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>


  </div>

  <div th:else>
<!--     <h3 th:if="${searchparameter.search != }"> 검색된 항목이 없습니다. </h3>-->
  </div>

<!--  <p th:text="${searchparameter.page}"></p>-->
<!--  <p th:text="${searchparameter.search}"></p>-->


<!--  <p th:text="${data.hits.hits[0]._source.title}"></p>-->





</div>

</br></br>





<script type="text/javascript">

  // const timestamp = `[${new Date().toUTCString()}]`;
  var search = document.querySelector('#searchparam');
  var choice = document.getElementById('choice').value;
  var target = document.getElementById('targetHidden').value;
  var category = document.getElementById('categoryHidden').value;
  document.getElementById("categoryInnerLine").innerText = category;
  var research = document.getElementById('flexSwitchCheckDefault').checked;

  // console.log(research, timestamp);

  // console.log(target); // 초기화된 값 출력 (콘솔 확인용)
  // console.log(search); // 초기화된 값 출력 (콘솔 확인용)
  // console.log(choice); // 초기화된 값 출력 (콘솔 확인용)

  function setValue(value) {
    // console.log("Selected value: " + value);
    target = value;
  }

  function setCategoryValue(value) {
    category = value;

    document.getElementById("categoryInnerLine").innerText = category;
  }

  function setChoice(value) {
    // alert("on here!!");
    choice = value;
  }
  function SearchOption() {
    if (research == undefined){
      research = false;
    }
    // alert(choice);

    if (research == false){
      var searchValue = encodeURIComponent(search.value);
      window.location.href = "/searchlist?page=1&choice=" + choice + "&search=" + searchValue + "&target=" + target + "&research=" + research + "&category=" + category + "&query=" + searchValue;
    } else {
      var originSearch = document.getElementById('searchHidden').value;
      var searchValue = encodeURIComponent(search.value);
      var receivedData = document.getElementById('searchArr').value;
      var searchwordRegex = /\[ReDiscover\(searchword=(.*?)\)\]/;
      var matches = receivedData.match(searchwordRegex);
      var searchwords = matches ? matches[1].split(',') : [];

      console.log("추출된 검색어들: ", searchwords);

      var url = "/searchlist?page=1&choice=" + choice + "&search=" + encodeURIComponent(originSearch) + "&target=" + target + "&research=" + research + "&searchword=" + encodeURIComponent(search.value) + "&query=" + searchValue;

      for (var i = 0; i < searchwords.length; i++) {
        url += "&searchword=" + encodeURIComponent(searchwords[i]);
      }

      url += "&category=" + category;

      window.location.href = url;
    }
  }


  function goToPrev(event){
    var currentURL = window.location.href;

    // URL에서 "page" 파라미터의 값을 가져옴
    var urlParams = new URLSearchParams(new URL(currentURL).search);
    var currentPage = parseInt(urlParams.get("page"));

    // 현재 페이지가 1보다 큰 경우에만 -1을 적용하여 새로운 페이지 번호 계산
    if (currentPage > 1) {
      var newPage = currentPage - 1;

      // URL에서 "page" 파라미터를 새로운 페이지 번호로 변경
      urlParams.set("page", newPage);

      // 변경된 URL을 새로운 URL로 생성
      var newURL = currentURL.split("?")[0] + "?" + urlParams.toString();

      // 페이지 이동
      window.location.href = newURL;
    }

  }

  function goToNext() {
    var currentURL = window.location.href;

    // URL에서 "page" 파라미터의 값을 가져옴
    var urlParams = new URLSearchParams(new URL(currentURL).search);
    var currentPage = parseInt(urlParams.get("page"));

    // 페이지 증가
    var newPage = currentPage + 1;

    // URL에서 "page" 파라미터를 새로운 페이지 번호로 변경
    urlParams.set("page", newPage);

    // 변경된 URL을 새로운 URL로 생성
    var newURL = currentURL.split("?")[0] + "?" + urlParams.toString();

    // 페이지 이동
    window.location.href = newURL;
  }

  function goToFirstPage() {
    var currentURL = window.location.href;
    var urlParams = new URLSearchParams(new URL(currentURL).search);

    // "page" 파라미터를 1로 설정
    urlParams.set("page", 1);

    // 변경된 URL을 새로운 URL로 생성
    var newURL = currentURL.split("?")[0] + "?" + urlParams.toString();

    // 페이지 이동
    window.location.href = newURL;
  }

  function goToLastPage(totalPages) {
    var currentURL = window.location.href;
    var urlParams = new URLSearchParams(new URL(currentURL).search);

    // "page" 파라미터를 totalPages로 설정
    urlParams.set("page", totalPages);

    // 변경된 URL을 새로운 URL로 생성
    var newURL = currentURL.split("?")[0] + "?" + urlParams.toString();

    // 페이지 이동
    window.location.href = newURL;
  }

  function goToPage(pageNumber) {
    var currentURL = window.location.href;
    var urlParams = new URLSearchParams(new URL(currentURL).search);

    // 페이지 번호를 클릭된 페이지로 설정
    urlParams.set("page", pageNumber);

    // 변경된 URL을 새로운 URL로 생성
    var newURL = currentURL.split("?")[0] + "?" + urlParams.toString();

    // 페이지 이동
    window.location.href = newURL;
  }






  function updateReSearch() {
    research = document.getElementById("flexSwitchCheckDefault").checked;
    console.log(research);
  }

  document.getElementById('choice').onchange = function() {
    choice = document.getElementById('choice').value;
  };




</script>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
</html>